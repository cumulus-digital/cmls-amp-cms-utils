"use strict";(self.cmlsAmpUtils=self.cmlsAmpUtils||[]).push([[510],{4711:function(e,t,o){o.r(t),o(7658),o(6229),o(7330),o(2062),((e,t)=>{const{h:n}=e._CMLS.libs,{throttle:r,debounce:a}=e._CMLS.libs.lodash,i="wallpaperHandler",s="cmls-wallpaper",l=new e._CMLS.Logger("WALLPAPER HANDLER 0.1"),c=e.document,d={injectTo:".wrapper-content",contentArea:".wrapper-content > .grid-container",alwaysAbove:".wrapper-header, .wrapper-footer",obstructions:".takeover-left,.takeover-right,.skyscraper-left,.skyscraper-right,.fs-sidewall-container,.cmls-sidewalls",preDisplay:null,postDisplay:null};e._CMLS[i]||(e._CMLS[i]=new function(t={}){this.refreshNodeCache=()=>{if(Object.assign(this.nodeCache,{injectTo:c.querySelector(a.injectTo),contentArea:c.querySelector(a.contentArea),alwaysAbove:[...c.querySelectorAll(a.alwaysAbove)],obstructions:[...c.querySelectorAll(a.obstructions)]}),!this.nodeCache.injectTo||!this.nodeCache.contentArea)throw l.warn(this.nodeCache),this.reset(),new Error("Could not locate important DOM nodes!")},this.generateHash=(e,t=0)=>{let o=3735928559^t,n=1103547991^t;for(let t,r=0;r<e.length;r++)t=e.charCodeAt(r),o=Math.imul(o^t,2654435761),n=Math.imul(n^t,1597334677);return o=Math.imul(o^o>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507)^Math.imul(o^o>>>13,3266489909),(4294967296*(2097151&n)+(o>>>0)).toString()},this.getContainer=(e=!1)=>{const t=`${s}-container`,r=`${s}-container`,a=c.getElementById(t);if(a)return this.nodeCache.container=a,this.nodeCache.container;if(e)return!1;l.info("Generating new container"),this.refreshNodeCache();const i=n("div",{id:t,class:r});return i.attachShadow({mode:"open"}),Promise.all([o.e(216),o.e(611)]).then(o.bind(o,4105)).then((e=>{e?.default?.use&&e.default.use({target:i.shadowRoot})})),this.nodeCache.injectTo.prepend(i),this.nodeCache.container=i,this.raiseContentArea(),this.nodeCache.container},this.getComputedStyles=()=>{if(r)return r;Object.assign(r,{injectTo:e.getComputedStyle(this.nodeCache.injectTo),contentArea:e.getComputedStyle(this.nodeCache.contentArea),alwaysAbove:this.nodeCache.alwaysAbove.map((t=>e.getComputedStyle(t)))})},this.raiseContentArea=()=>{const t=this.getContainer(),o=e.getComputedStyle(t),n=parseInt(o.zIndex)||0,r=this.getComputedStyles();for(key in r)["relative","static"].includes(r[key]?.position)&&(l.debug(`Setting ${key} position to relative.`),this.nodeCache[key]?.style?.setProperty("position","relative")),("auto"===r[key]?.zIndex||Number.isInteger(r[key]?.zIndex)&&parseInt(r[key]?.zIndex)<=n)&&this.nodeCache[key]?.style?.setProperty("z-index",n+10)},this.clearObstructions=()=>{l.debug("Clearing obstructions."),e.NO_SIDEWALLS=!0,this.nodeCache.obstructions?.length&&this.nodeCache.obstructions.forEach((t=>{if(e._CMLS?.adTag){const o=[],n=[...t.querySelectorAll('[id^="div-gpt-ad"],[data-google-query-id],iframe[id^="google_ads_iframe"]')];if(n?.length&&n.forEach((e=>{let t=e;"iframe"===t.nodeName&&(t=e.parentNode),o.push(t.id)})),o.length){l.debug("Found ads in obstructions",o);const t=[];e._CMLS.adTag.getSlots().forEach((e=>{o.includes(e.getSlotElementId())&&t.push(e)})),t.length&&(l.debug("Found ad slots to kill",t),e._CMLS.adTag.destroySlots(t))}}t.remove()}))},this.reset=()=>{l.info("Resetting.");const e=this.getContainer(!0);e&&(e.style.setProperty("--background-color","rgba(0,0,0,0)"),e.classList.remove(`${s}-open`),e.removeAttribute("data-hash"),e.innerHTML="")},this.showContainer=()=>{l.info("Displaying wallpaper"),this.getContainer().classList.add(`${s}-open`),"function"==typeof a.postDisplay&&a.postDisplay.call(this)},this.process=t=>{l.info("Processing request");const o=this.getContainer(),r=t.getResponseInformation(),i=["advertiserId","campaignId","creativeId","lineItemId"].map((e=>r?.[e])).join("");if(l.debug("Generated hash",i),i===o.getAttribute("data-hash"))return void l.info("Returned creative is already displaying");this.refreshNodeCache();const s=c.getElementById(t.getSlotElementId());if(!s)return l.warn("Could not select slot element"),void this.reset();const d=s.querySelector("iframe");if(!d)return l.warn("Could not select slot iframe"),void this.reset();if(!d.contentWindow||"true"===d.getAttribute("data-is-safeframe"))return l.warn("Could not get slot iframe window, is this a safe frame?"),void this.reset();const h=d.contentWindow.document.querySelector("#google_image_div, body");if(!h)return l.warn("Could not get slot inner element"),void this.reset();let u=h.querySelector('a[target="_blank"],a[target="_top"]'),g=h.querySelector(".img_ad");if(!g&&(g=h.querySelector('img[src]:not([width="1"]):not([width="0"])'),!g))return l.warn("No image found in ad slot"),void this.reset();const p=u.getAttribute("href"),f=new URL(e.location.href).origin,m=new URL(p,f);this.reset(),o.setAttribute("data-hash",i),"function"==typeof a.preDisplay&&a.preDisplay.call(this);let y=u.getAttribute("target");y||(y=m.origin===f?"_top":"_blank");const b=u?n("a",{href:u.getAttribute("href"),target:y,rel:"_blank"===y?"noopener":""}):n("span",null);b.href&&e._CMLS?.navThroughPlayer&&e._CMLS.navThroughPlayer.updateLink(b),l.info("Building wallpaper into container",u,g);const C=n("div",{class:"wrap"},b);o.shadowRoot.append(C),g.getAttribute("alt")?.includes("contain")&&o.style.setProperty("--background-size: 100%"),o.style.setProperty("--background-image",`url(${g.getAttribute("src")})`);const w=new RegExp("(#[a-z0-9]+)?(rgba([0-9,s]+))?","i"),A=g.getAttribute("alt");if(A&&w.test(A)){const e=A.match(w);e?.length&&(l.debug("Setting background color from creative attribute",e[1]),o.style.setProperty("--background-color",e[1])),this.showContainer()}else this.getBackgroundColorFromImage(g).then((e=>{l.debug("Setting background color from image",e),o.style.setProperty("--background-color",e),this.showContainer()}))},this.getBackgroundColorFromImage=e=>e&&e.getAttribute("src")?(l.debug("Generating background color from creative"),new Promise(((t,o)=>{const r=new XMLHttpRequest;r.onload=()=>{const e=new FileReader;e.onloadend=()=>{const r=e.result;if(r){l.debug("Got data URI for image");const e=new Image;e.onload=()=>{const r=n("canvas",null),a=r.getContext("2d"),i=e.naturalWidth||e.offsetWidth||e.width,s=e.naturalHeight||e.offsetHeight||e.height,c={x:i/2,y:s/2};r.width=i,r.height=s,a.drawImage(e,0,0),l.debug("Getting color from image center point",c);const d=a.getImageData(c.x,c.y,1,1);if(d?.data){l.debug("Got color!",d.data);const e=d.data.slice(0,3);return t(`rgba(${e.join(",")}, 1)`)}return l.warn("Could not get color data from image"),o(null)},e.setAttribute("src",r)}},e.readAsDataURL(r.response)},r.open("GET",e.getAttribute("src")),r.responseType="blob",r.send()}))):"transparent",l.info("Handler loaded."),this.nodeCache={};const r={},a=Object.assign(d,{preDisplay:this.clearObstructions,postDisplay:this.clearObstructions},t);Promise.all([o.e(216),o.e(188)]).then(o.bind(o,1886)).then((e=>{e?.default?.use&&e.default.use()})),this.refreshNodeCache()})})(window.self)}}]);