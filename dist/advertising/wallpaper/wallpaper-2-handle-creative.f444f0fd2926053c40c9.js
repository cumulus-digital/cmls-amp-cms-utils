"use strict";(self.cmlsAmpUtils=self.cmlsAmpUtils||[]).push([[501],{2933:function(e,t,o){o.r(t),o(4114),o(4603),o(7566),o(8721),((e,t)=>{const{h:n,Logger:r,lodash:a}=e.__CMLSINTERNAL.libs,{throttle:s,debounce:i}=a,l="wallpaperHandler",d="cmls-wallpaper",c=new r("WALLPAPER HANDLER 0.1"),h=e.document,u={injectTo:".wrapper-content",contentArea:".wrapper-content > .grid-container",alwaysAbove:".wrapper-header, .wrapper-footer",obstructions:".takeover-left,.takeover-right,.skyscraper-left,.skyscraper-right,.fs-sidewall-container,.cmls-sidewalls",preDisplay:null,postDisplay:null};e.__CMLSINTERNAL[l]||(e.__CMLSINTERNAL[l]=new function(t={}){this.refreshNodeCache=()=>{if(Object.assign(this.nodeCache,{injectTo:h.querySelector(a.injectTo),contentArea:h.querySelector(a.contentArea),alwaysAbove:[...h.querySelectorAll(a.alwaysAbove)],obstructions:[...h.querySelectorAll(a.obstructions)]}),!this.nodeCache.injectTo||!this.nodeCache.contentArea)throw c.warn(this.nodeCache),this.reset(),new Error("Could not locate important DOM nodes!")},this.generateHash=(e,t=0)=>{let o=3735928559^t,n=1103547991^t;for(let t,r=0;r<e.length;r++)t=e.charCodeAt(r),o=Math.imul(o^t,2654435761),n=Math.imul(n^t,1597334677);return o=Math.imul(o^o>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507)^Math.imul(o^o>>>13,3266489909),(4294967296*(2097151&n)+(o>>>0)).toString()},this.getContainer=(e=!1)=>{const t=`${d}-container`,r=`${d}-container`,a=h.getElementById(t);if(a)return this.nodeCache.container=a,this.nodeCache.container;if(e)return!1;c.debug("Generating new container"),this.refreshNodeCache();const s=n("div",{id:t,class:r});return s.attachShadow({mode:"open"}),Promise.all([o.e(96),o.e(45)]).then(o.bind(o,4944)).then((e=>{e?.default?.use&&e.default.use({target:s.shadowRoot})})),this.nodeCache.injectTo.prepend(s),this.nodeCache.container=s,this.raiseContentArea(),this.nodeCache.container},this.getComputedStyles=()=>{if(r)return r;Object.assign(r,{injectTo:e.getComputedStyle(this.nodeCache.injectTo),contentArea:e.getComputedStyle(this.nodeCache.contentArea),alwaysAbove:this.nodeCache.alwaysAbove.map((t=>e.getComputedStyle(t)))})},this.raiseContentArea=()=>{const t=this.getContainer(),o=e.getComputedStyle(t),n=parseInt(o.zIndex)||0,r=this.getComputedStyles();for(key in r)["relative","static"].includes(r[key]?.position)&&(c.debug(`Setting ${key} position to relative.`),this.nodeCache[key]?.style?.setProperty("position","relative")),("auto"===r[key]?.zIndex||Number.isInteger(r[key]?.zIndex)&&parseInt(r[key]?.zIndex)<=n)&&this.nodeCache[key]?.style?.setProperty("z-index",n+10)},this.clearObstructions=()=>{c.debug("Clearing obstructions.",this.nodeCache.obstructions);const t=e.__CMLSINTERNAL?.adTag;e.NO_SIDEWALLS=!0,e.__CMLSINTERNAL?.sidewallAds?.destroy&&e.__CMLSINTERNAL?.sidewallAds?.destroy(),this.nodeCache.obstructions?.length&&this.nodeCache.obstructions.forEach((e=>{if(t){const o=[],n=[...e.querySelectorAll('[id^="div-gpt-ad"],[data-google-query-id],iframe[id^="google_ads_iframe"]')];if(n?.length&&n.forEach((e=>{let t=e;"iframe"===t.nodeName&&(t=e.parentNode),o.push(t.id)})),o.length){c.debug("Found ads in obstructions",o);const e=[];t.getSlots().forEach((t=>{o.includes(t.getSlotElementId())&&e.push(t)})),e.length&&(c.debug("Found ad slots to kill",e),t.destroySlots(e))}}e.remove()}))},this.reset=()=>{c.debug("Resetting.");const e=this.getContainer(!0);e&&(e.style.setProperty("--background-color","rgba(0,0,0,0)"),e.classList.remove(`${d}-open`),e.removeAttribute("data-hash"),e.innerHTML="")},this.showContainer=()=>{c.debug("Displaying wallpaper"),this.getContainer().classList.add(`${d}-open`),"function"==typeof a.postDisplay&&a.postDisplay.call(this)},this.process=t=>{c.debug("Processing request");const o=this.getContainer(),r=t.getResponseInformation(),s=["advertiserId","campaignId","creativeId","lineItemId"].map((e=>r?.[e])).join("");if(c.debug("Generated hash",s),s===o.getAttribute("data-hash"))return void c.info("Received creative which is already displaying.");this.refreshNodeCache();const i=h.getElementById(t.getSlotElementId());if(!i)return c.warn("Could not select slot element"),void this.reset();const l=i.querySelector("iframe");if(!l)return c.warn("Could not select slot iframe"),void this.reset();if(!l.contentWindow||"true"===l.getAttribute("data-is-safeframe"))return c.warn("Could not get slot iframe window, is this a safe frame?"),void this.reset();const d=l.contentWindow.document.querySelector("#google_image_div, body");if(!d)return c.warn("Could not get slot inner element"),void this.reset();let u=d.querySelector('a[target="_blank"],a[target="_top"]'),g=d.querySelector(".img_ad");if(!g&&(g=d.querySelector('img[src]:not([width="1"]):not([width="0"])'),!g))return c.warn("No image found in ad slot"),void this.reset();const p=u.getAttribute("href"),b=new URL(e.location.href).origin,m=new URL(p,b);this.reset(),o.setAttribute("data-hash",s),"function"==typeof a.preDisplay&&a.preDisplay.call(this);let f=u.getAttribute("target");f||(f=m.origin===b?"_top":"_blank");const y=u?n("a",{href:u.getAttribute("href"),target:f,rel:"_blank"===f?"noopener":""}):n("span",null);y.href&&e.__CMLSINTERNAL?.navThroughPlayer&&e.__CMLSINTERNAL.navThroughPlayer.updateLink(y),c.debug("Building wallpaper into container",u,g);const C=n("div",{class:"wrap"},y);o.shadowRoot.append(C),g.getAttribute("alt")?.includes("contain")&&o.style.setProperty("--background-size: 100%"),o.style.setProperty("--background-image",`url(${g.getAttribute("src")})`);const w=new RegExp("(#[a-z0-9]+)?(rgba([0-9,s]+))?","i"),A=g.getAttribute("alt");if(A&&w.test(A)){const e=A.match(w);e?.length&&(c.debug("Setting background color from creative attribute",e[1]),o.style.setProperty("--background-color",e[1])),this.showContainer()}else this.getBackgroundColorFromImage(g).then((e=>{c.debug("Setting background color from image",e),o.style.setProperty("--background-color",e),this.showContainer()}))},this.getBackgroundColorFromImage=e=>e&&e.getAttribute("src")?(c.debug("Generating background color from creative"),new Promise(((t,o)=>{const r=new XMLHttpRequest;r.onload=()=>{const e=new FileReader;e.onloadend=()=>{const r=e.result;if(r){c.debug("Got data URI for image");const e=new Image;e.onload=()=>{const r=n("canvas",null),a=r.getContext("2d"),s=e.naturalWidth||e.offsetWidth||e.width,i=e.naturalHeight||e.offsetHeight||e.height,l={x:s/2,y:i/2};r.width=s,r.height=i,a.drawImage(e,0,0),c.debug("Getting color from image center point",l);const d=a.getImageData(l.x,l.y,1,1);if(d?.data){c.debug("Got color!",d.data);const e=d.data.slice(0,3);return t(`rgba(${e.join(",")}, 1)`)}return c.warn("Could not get color data from image"),o(null)},e.setAttribute("src",r)}},e.readAsDataURL(r.response)},r.open("GET",e.getAttribute("src")),r.responseType="blob",r.send()}))):"transparent",c.info("Handler loaded."),this.nodeCache={};const r={},a=Object.assign(u,{preDisplay:this.clearObstructions,postDisplay:this.clearObstructions},t);Promise.all([o.e(96),o.e(284)]).then(o.bind(o,1914)).then((e=>{e?.default?.use&&e.default.use()})),this.refreshNodeCache()})})(window.self)}}]);